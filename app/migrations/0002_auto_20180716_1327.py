# Generated by Django 2.0.3 on 2018-05-25 09:56

import os

from django.conf import settings
from django.core.files.images import ImageFile
from django.db import migrations

from app.consts import app_config_context
from app.manager.config_manager import cache_config
from app.manager.ct_manager import update_one_to_many_relation_model


def init_config(apps, schema_editor):
    Config = apps.get_model("app", "Config")
    db_alias = schema_editor.connection.alias

    Config.objects.using(db_alias).bulk_create([
        # é¡¶éƒ¨å›¾æ ‡æ 
        Config(name=app_config_context['top_ico'],
               config='{ "left": { "logo": "{%img|name=logo_white %}", "blog_name": "{%text| æ–‡å­—æ ‡é¢˜ | style=font-size:18px %}" }, "right": [ { "img": "{%fa|fab fa-github|style=color:#ffffff;font-size:24px %}", "url": "https://github.com/gojuukaze/DeerU" } ] }'),
        # é¡¶éƒ¨å¯¼èˆªæ 
        Config(name=app_config_context['top_menu'],
               config='[ { "url": "/", "name": "é¦–é¡µ", "img": "{% fa|fas fa-home %}" }, { "name": "æŠ˜å èœå•", "img": "{% fa|fas fa-list %}", "children": [ { "name": "é»˜è®¤åˆ†ç±»", "url": "{% cat|name=é»˜è®¤åˆ†ç±»|url%}" }, { "line": "line" }, { "name": "DeerU", "url": "{% tag|DeerU|url%}" } ] } ]'),
        # å…¨å±€å˜é‡
        Config(name=app_config_context['global_value'],
               config='{ "title": "Deeru - å¼€æºåšå®¢ç³»ç»Ÿ", "blog_name": "Deeru - å¼€æºåšå®¢ç³»ç»Ÿ", "nickname": "gojuukaze" }'),

        # å…¶ä»–é…ç½®
        Config(name=app_config_context['common_config'],
               config='{ "theme": "base_theme", "baidu_auto_push": 0 }'),
    ])
    for config in Config.objects.all():
        cache_config(config, True)


def upload_img(model, name, path):
    with open(path, 'rb')as f:
        img = ImageFile(f)
        a = model(name=name)
        a.img.save(name, img)


def init_img(apps, schema_editor):
    Album = apps.get_model("app", "Album")
    base_dir = settings.BASE_DIR
    upload_img(Album, 'logo_white.png', os.path.join(base_dir, 'logo_white.png'))
    upload_img(Album, 'logo_black.png', os.path.join(base_dir, 'logo_black.png'))

    upload_img(Album, 'deeru_green.png', os.path.join(base_dir, 'deeru_green.png'))


def init_content(apps, schema_editor):
    Category = apps.get_model("app", "Category")
    c = Category.objects.create(name='é»˜è®¤åˆ†ç±»')

    Tag = apps.get_model("app", "Tag")
    t = Tag.objects.create(name='DeerU')

    Album = apps.get_model("app", "Album")
    logo_black = Album.objects.get(name='logo_black.png')
    deeru_green = Album.objects.get(name='deeru_green.png')

    Article = apps.get_model("app", "Article")
    a = Article.objects.create(title='æ¬¢è¿ä½¿ç”¨DeerU',
                               content='<p><img src="%s" data-name="logo_black.png" data-id="2" style="width: 229px;" class="fr-fic fr-dib"></p><p><br></p><hr><p style="text-align: center;"><br></p><p style="text-align: center;"><span style="font-size: 18px;"><strong>æ„Ÿè°¢ä½ ä½¿ç”¨DeerU<span class="fr-emoticon fr-deletable">ğŸ˜€</span> </strong> </span></p><p style="text-align: center;"><strong><span style="font-size: 18px;">DeerUæ˜¯ä¸€ä¸ªå…è´¹å¼€æºçš„åšå®¢ç³»ç»Ÿ</span></strong></p><p style="text-align: center;"><br></p><p style="text-align: center;"><strong><span style="font-size: 18px;">ä¸ºä»€ä¹ˆä½¿ç”¨DeerU ï¼Ÿ</span></strong></p><p style="text-align: center;"><strong><span style="font-size: 18px;">1. <strong><span style="font-size: 18px;">DeerU</span></strong>æ›´é€‚åˆç¨‹åºå‘˜ </span> </strong></p><p style="text-align: center;"><strong><span style="font-size: 18px;">ï¼ˆå®ƒæ‰€æœ‰çš„é…ç½®å‡é‡‡ç”¨jsonæ ¼å¼è¿›è¡Œé…ç½®ï¼‰ </span></strong></p><p style="text-align: center;"><strong><span style="font-size: 18px;">2. DeerUå¯¹å‰ç«¯å¼€å‘äººå‘˜æ›´å‹å¥½ </span></strong></p><p style="text-align: center;"><strong><span style="font-size: 18px;">ï¼ˆå®ƒä¸ºæ¯ä¸ªé¡µé¢éƒ½æä¾›äº†è¿”å›jsonæ•°æ®çš„æ¥å£ï¼Œä½ å¯ä»¥ä¸ä¾èµ–Djangoæ¨¡æ¿å¼€å‘ä¸»é¢˜ï¼‰</span></strong></p><p style="text-align: center;"><br></p><p style="text-align: center;"><strong><span style="font-size: 18px;">å¦‚æœä½ æœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…å»ºè®®æ¬¢è¿è”ç³»åé¦ˆç»™æˆ‘</span></strong></p><p style="text-align: center;"><br></p><p style="text-align: center;"><strong><span style="font-size: 18px;">GITHUB: </span></strong><a href="https://github.com/gojuukaze/DeerU" rel="noopener noreferrer" target="_blank"><strong><span style="font-size: 18px;">https://github.com/gojuukaze/DeerU</span></strong></a></p><p style="text-align: center;"><strong><span style="font-size: 18px;">Documentation: <a class="fr-strong" data-fr-linked="true" href="https://deeru.readthedocs.ioâ€‹â€‹â€‹" rel="noopener noreferrer" target="_blank">https://deeru.readthedocs.io</a></span></strong></p><p style="text-align: center;"><strong><span style="font-size: 18px;">æ’ä»¶ä¸»é¢˜:  <a class="fr-strong" data-fr-linked="true" href="https://github.com/gojuukaze/deeru_plugin_theme" rel="noopener noreferrer" target="_blank">https://github.com/gojuukaze/deeru_plugin_theme</a></span></strong></p>' % logo_black.img.url,
                               summary='æ¬¢è¿ä½ ä½¿ç”¨DeerUğŸ˜€<br>DeerUæ˜¯ä¸€ä¸ªå…è´¹å¼€æºçš„åšå®¢ç³»ç»Ÿ<br>å¦‚æœä½ æœ‰ä»€ä¹ˆé—®é¢˜æˆ–è€…å»ºè®®æ¬¢è¿è”ç³»åé¦ˆç»™æˆ‘<br>...',
                               image=deeru_green.img.url
                               )
    ArticleMeta = apps.get_model("app", "ArticleMeta")
    ArticleMeta.objects.create(article_id=a.id)

    ArticleCategory = apps.get_model("app", "ArticleCategory")
    update_one_to_many_relation_model(ArticleCategory, 'article_id', a.id, 'category_id', [c.id],
                                      lambda x: x, [])
    ArticleTag = apps.get_model("app", "ArticleTag")
    update_one_to_many_relation_model(ArticleTag, 'article_id', a.id, 'tag_id', [t.id],
                                      lambda x: x, [])


class Migration(migrations.Migration):
    dependencies = [
        ('app', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(init_img),
        migrations.RunPython(init_content),
        migrations.RunPython(init_config),

    ]
